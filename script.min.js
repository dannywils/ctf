function mongolab(){var API_KEY="KWOsyikz7NuciZf8MhXdXZmZf9-Nxo51",DATABASE="capturetheflag";this.select=function(collection,query){return query=JSON.stringify(query),$.ajax({url:"https://api.mongolab.com/api/1/databases/"+DATABASE+"/collections/"+collection+"?q="+query+"&apiKey="+API_KEY,type:"GET",contentType:"application/json"})},this.insert=function(collection,content){return $.ajax({url:"https://api.mongolab.com/api/1/databases/"+DATABASE+"/collections/"+collection+"?apiKey="+API_KEY,data:JSON.stringify(content),type:"POST",contentType:"application/json"})},this.update=function(collection,query,update){return $.ajax({url:"https://api.mongolab.com/api/1/databases/"+DATABASE+"/collections/"+collection+"?apiKey="+API_KEY+"&q="+JSON.stringify(query),data:JSON.stringify({$set:update}),type:"PUT",contentType:"application/json"})},this.delete=function(collection,id){return $.ajax({url:"https://api.mongolab.com/api/1/databases/"+DATABASE+"/collections/"+collection+"/"+id+"?apiKey="+API_KEY,type:"DELETE",async:!0,timeout:3e5})},this.clear=function(collection,query){return $.ajax({url:"https://api.mongolab.com/api/1/databases/"+DATABASE+"/collections/"+collection+"?q="+JSON.stringify(query)+"&apiKey="+API_KEY,data:JSON.stringify([]),type:"PUT",contentType:"application/json"})}}function UUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=0|16*Math.random(),v="x"==c?r:8|3&r;return v.toString(16)})}function strToLat(location){return new google.maps.LatLng(location.split(",")[0],location.split(",")[1])}function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2){var R=6371,dLat=deg2rad(lat2-lat1),dLon=deg2rad(lon2-lon1),a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),d=R*c;return d}function deg2rad(deg){return deg*(Math.PI/180)}function otherTeam(team){return otherteam=1==team?2:1}function userExists(user,userArray){for(var i=userArray.length-1;i>=0;i--)if(user.uuid===userArray[i].uuid)return userArray[i]}function getUsersTeam(users){var teams=[],captain=!1;teams[1]=0,teams[2]=0;for(var i=users.length-1;i>=0;i--)if(void 0!==users[i].team){var team=users[i].team;1==team?teams[1]++:2==team&&teams[2]++}var team=1;return teams[1]>teams[2]&&(team=2),0==teams[team]&&(captain=!0),{team:team,captain:captain}}function checkBase(){var otherteam=otherTeam(user.team);bases[1]&&bases[2]&&inBase(otherteam)&&!user.hasflag?$(".captureflag").show():$(".captureflag").hide()}function score(){user.hasflag&&(user.hasflag=!1,$(".message").hide(),$("#scored").slideDown("slow").delay(1500).slideUp("slow"),$.when(db.select("teams",{team:user.team}),db.update("users",{uuid:user.uuid},{hasflag:!1})).then(function(teams){db.update("teams",{team:user.team},{pickedup:!1,score:teams[0][0].score+1})}))}function inBase(team){var base,latlng=strToLat(user.location);for(var key in circles)key==team&&(base=circles[key]);if(void 0!==base){var bounds=base.getBounds();return bounds.contains(latlng)}return!1}function userHasFlag(userArray,team){for(var i=userArray.length-1;i>=0;i--)userArray[i].hasflag&&userArray[i].team===team;return!1}function mapper(){google.maps.visualRefresh=!0;var map=new google.maps.Map(document.getElementById("map"),{zoom:25,center:new google.maps.LatLng(44.648900999999995,-63.57533499999999),mapTypeId:google.maps.MapTypeId.ROADMAP,panControl:!1,zoomControl:!1,mapTypeControl:!1,scaleControl:!1,streetViewControl:!1,overviewMapControl:!1,scrollwheel:!0,navigationControl:!1,mapTypeControl:!1,scaleControl:!0,backgroundColor:"#4b59dc",draggable:!0});this.map=map;var infowindow=new google.maps.InfoWindow({size:new google.maps.Size(150,50)});this.clear=function(){for(var i=0;i<markers.length;i++)markers[i].setMap(null);markers=new Array},this.center=function(latlng){map.setCenter(latlng)},this.placeMarker=function(uuid,location,text,icon){if(void 0===text)var text="";if(void 0!==location){var latlng=strToLat(location),marker=markers[uuid];if(void 0===marker)return this.createMarker(uuid,latlng,text,icon),void 0;null==marker.getMap()&&marker.setMap(map),marker.getPosition().equals(latlng)||(marker.setPosition(latlng),uuid==user.uuid&&marker.setAnimation(google.maps.Animation.BOUNCE))}},this.createMarker=function(uuid,latlng,text,icon){var zindex=0,isCurrentUser=!1;uuid==user.uuid&&(zindex=1,isCurrentUser=!0);var marker=new google.maps.Marker({map:map,position:latlng,zIndex:zindex});return isCurrentUser&&marker.setAnimation(google.maps.Animation.BOUNCE),marker.setIcon(icon),markers[uuid]=marker,google.maps.event.addListener(marker,"click",function(){infowindow.setContent("<strong>"+text+"</strong><br>"),infowindow.open(map,marker)}),marker},this.placeCircle=function(uuid,center,color){var latlng=strToLat(center),circle=circles[uuid];return void 0===circle?(this.createCircle(uuid,latlng,color),void 0):(circle.getCenter().equals(latlng)||(circle.setMap(null),this.createCircle(uuid,latlng,color)),void 0)},this.createCircle=function(uuid,latlng,color){var options={strokeColor:color,strokeOpacity:.8,strokeWeight:2,fillColor:color,fillOpacity:.35,map:map,center:latlng,radius:10},circle=new google.maps.Circle(options);circles[uuid]=circle}}function watchLocation(successCallback,errorCallback){function handleSuccess(position){successCallback(position.coords)}successCallback=successCallback||function(){},errorCallback=errorCallback||function(){};var geolocation=navigator.geolocation;if(geolocation)try{geolocation.watchPosition(handleSuccess,errorCallback,{enableHighAccuracy:!0,maximumAge:0})}catch(err){errorCallback()}else errorCallback()}function game(){db=new mongolab,map=new mapper;var parent=this,setup=function(){var username=$.cookie("username"),uuid=$.cookie("uuid");if(void 0===username||void 0===uuid){for(;void 0===username||null==username;)username=prompt("Please enter your name","Enter Name");$.cookie("username",username,{expires:1}),$.cookie("uuid",UUID(),{expires:1}),uuid=$.cookie("uuid")}user={uuid:uuid,username:username}},initializeUser=function(){var timeout=new Date((new Date).getTime()-6e5).toISOString();$.when(db.select("users",{date:{$gt:timeout}})).then(function(users){var checkUser=userExists(user,users);if(void 0!==checkUser)user=checkUser,startGame();else{var team=getUsersTeam(users);user={username:user.username,uuid:user.uuid,team:team.team,captain:team.captain,date:(new Date).toISOString(),out:!1},$.when(db.insert("users",user)).then(function(){startGame()})}})},startGame=function(){$(".result").html(user.username),user.captain&&$(".captain").show(),$(".team").html("Team "+user.team),$(".overlay").addClass("team"+user.team),initializeLocation(),setInterval(function(){refresh()},1e3)},refresh=function(){var timeout=new Date(10^(new Date).getTime()-6e5).toISOString();$.when(db.select("users",{date:{$gt:timeout}}),db.select("teams",{})).then(function(users,flags){handleUsers(users[0]),handleFlags(flags[0]),bases[user.team]&&bases[otherTeam(user.team)]&&$(".player").show(),userHasFlag(users[0]),otherTeam(user.team)&&checkBase(),user.out&&($(".player").hide(),$(".message").show())}),user.hasflag&&inBase(user.team)&&score(),user.out&&inBase(user.team)&&(user.out=!1,tagDistance=.005,$(".player").show(),$(".message").hide(),db.update("users",{uuid:user.uuid},{out:!1}))},handleUsers=function(users){for(var enemies=0,i=users.length-1;i>=0;i--)if(users[i].uuid===user.uuid?user=users[i]:0==users[i].out&&map.placeMarker(users[i].uuid,users[i].location,users[i].username,"images/"+flagcolors[users[i].team-1]+"-player.png"),users[i].team!==user.team&&void 0!==user.location&&0==user.out&&0==users[i].out&&void 0!==users[i].location){var lat1=user.location.split(",")[0],lon1=user.location.split(",")[1],lat2=users[i].location.split(",")[0],lon2=users[i].location.split(",")[1];getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2)<tagDistance&&(enemies++,$("button.tag").data("uuid",users[i].uuid).show())}0==enemies&&$("button.tag").hide(),map.placeMarker(user.uuid,user.location,"You ("+user.username+")","images/"+flagcolors[user.team-1]+"-player.png"),user.hasflag&&$(".message").show()},handleFlags=function(teams){for(var i=teams.length-1;i>=0;i--){var team=teams[i];void 0!==team.pickedup&&team.pickedup||map.placeMarker(team.uuid,team.flag,"Flag "+team.team,"images/"+flagcolors[team.team-1]+"-flag.png"),map.placeCircle(team.team,team.base,basecolors[team.team-1]),bases[team.team]=!0,$(".score [data-team="+team.team+"]").text(team.score)}bases[user.team]?$(".placeflag").hide():$(".placeflag").show()},initializeLocation=function(){watchLocation(parent.updateCoords,function(){$(".coords").html("Error getting coordinates.")},{timeout:0})};this.updateCoords=function(coords){if(user.location=coords.latitude+","+coords.longitude,$(".coords").html(user.location),db.update("users",{uuid:user.uuid},{location:user.location,date:(new Date).toISOString()}),refresh(),void 0!==user.location){var latlng=new google.maps.LatLng(user.location.split(",")[0],user.location.split(",")[1]);map.center(latlng)}},setup(),initializeUser()}!function(factory){"function"==typeof define&&define.amd?define(["jquery"],factory):factory(jQuery)}(function($){function raw(s){return s}function decoded(s){return decodeURIComponent(s.replace(pluses," "))}function converted(s){0===s.indexOf('"')&&(s=s.slice(1,-1).replace(/\\"/g,'"').replace(/\\\\/g,"\\"));try{return config.json?JSON.parse(s):s}catch(er){}}var pluses=/\+/g,config=$.cookie=function(key,value,options){if(void 0!==value){if(options=$.extend({},config.defaults,options),"number"==typeof options.expires){var days=options.expires,t=options.expires=new Date;t.setDate(t.getDate()+days)}return value=config.json?JSON.stringify(value):String(value),document.cookie=[config.raw?key:encodeURIComponent(key),"=",config.raw?value:encodeURIComponent(value),options.expires?"; expires="+options.expires.toUTCString():"",options.path?"; path="+options.path:"",options.domain?"; domain="+options.domain:"",options.secure?"; secure":""].join("")}for(var decode=config.raw?raw:decoded,cookies=document.cookie.split("; "),result=key?void 0:{},i=0,l=cookies.length;l>i;i++){var parts=cookies[i].split("="),name=decode(parts.shift()),cookie=decode(parts.join("="));if(key&&key===name){result=converted(cookie);break}key||(result[name]=converted(cookie))}return result};config.defaults={},$.removeCookie=function(key,options){return void 0!==$.cookie(key)?($.cookie(key,"",$.extend({},options,{expires:-1})),!0):!1}});var markers=[],circles=[],user=null,flagcolors=["red","blu"],basecolors=["red","blue"],bases=[!1,!1],db,map,game,tagDistance=.005;window.onload=function(){game=new game},$(function(){$("button.captureflag").click(function(){$(this).hide(),$(".message").show(),db.update("teams",{team:otherTeam(user.team)},{pickedup:!0}),db.update("users",{uuid:user.uuid},{hasflag:!0})}),$("button.tag").click(function(){var uuid=$(this).data("uuid");db.update("users",{uuid:uuid},{out:!0,hasflag:!1}),markers[uuid].setMap(null),tagDistance+=.005}),$("button.placeflag").click(function(){$(this).remove(),db.insert("teams",{flag:user.location,base:user.location,team:user.team,uuid:UUID(),date:(new Date).toISOString(),score:0})}),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",function(e){var deg=360-e.alpha%360;$(".compass").css({"-webkit-transform":"rotate("+deg+"deg)"})},!1),$("body").click(function(){})});